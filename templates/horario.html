{% extends 'base.html' %}
{% block content %}

{% if horario %}
<div class="container mt-5">
    <h2>Horario Generado</h2>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Hora</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Miércoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
            </tr>
        </thead>
        <tbody>
            {% for hour in hours %}
            <tr>
                <td>{{ hour }}</td>
                {% for day in dias %}
                <td>
                    {% for materia in horario[day] %}
                    {% if materia.hora == hour %}
                    <span class="badge bg-primary text-light mb-1 d-block">{{ materia.nombre }}</span>
                    {% endif %}
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow border-0">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h2 class="mb-0">Horario Estudiante</h2>
                </div>
                <div class="card-body p-4">
                    <h5 class="card-title text-center mb-4">Agregar Nueva Materia</h5>
                    <form method="POST" id="materiasForm">
                        <div class="row mb-3">
                            <div class="col">
                                <div class="form-floating">
                                    <select id="materiasSelect" class="form-select">
                                        <option value="">Seleccionar materia</option>
                                        {% for materia in materias %}
                                        <option value="{{ materia.nombre }}" data-dias="{{ materia.dias|join(',') }}"
                                            data-horas="{{ materia.hora|join(',') }}">
                                            {{ materia.nombre }} - {{ materia.profesor }} ({{ materia.dias|join(', ')
                                            }}) -
                                            {{ materia.hora|join(' / ') }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <label for="materiasSelect">Materias Disponibles</label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mb-4">
                            <button type="button" id="addMateriaBtn" class="btn btn-secondary">Agregar Materia</button>
                        </div>

                        <div class="card border-light shadow-sm mb-4">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 fw-bold"><i class="bi bi-table me-2"></i> Vista Previa del Horario</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="tablaMaterias">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Hora</th>
                                                <th>Lunes</th>
                                                <th>Martes</th>
                                                <th>Miércoles</th>
                                                <th>Jueves</th>
                                                <th>Viernes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>


                        <div class="d-grid gap-2">
                            <button type="button" id="guardarBtn" class="btn btn-primary"><i
                                    class="bi bi-download me-2"></i> Guardar y Generar PDF</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const diasMapping = {
        "Lunes": 1,
        "Martes": 2,
        "Miércoles": 3,
        "Jueves": 4,
        "Viernes": 5
    };

    function buscarFilaPorHora ( hora )
    {
        const tbody = document.getElementById( 'tablaMaterias' ).getElementsByTagName( 'tbody' )[ 0 ];
        for ( let row of tbody.rows )
        {
            if ( row.cells[ 0 ].textContent.trim() === hora.trim() )
            {
                return row;
            }
        }
        return null;
    }

    function crearFilaHorario ( hora )
    {
        const tbody = document.getElementById( 'tablaMaterias' ).getElementsByTagName( 'tbody' )[ 0 ];
        const row = tbody.insertRow();
        const cellHora = row.insertCell( 0 );
        cellHora.textContent = hora;
        for ( let i = 1; i <= 5; i++ )
        {
            row.insertCell( i ).textContent = "";
        }
        return row;
    }

    document.getElementById( 'addMateriaBtn' ).addEventListener( 'click', function ()
    {
        const select = document.getElementById( 'materiasSelect' );
        const selectedOption = select.options[ select.selectedIndex ];

        if ( selectedOption.value !== "" )
        {
            const materiaNombre = selectedOption.value;
            const diasMateria = selectedOption.getAttribute( 'data-dias' ).split( ',' ).map( d => d.trim() );
            const horasMateria = selectedOption.getAttribute( 'data-horas' ).split( ',' ).map( h => h.trim() );

            horasMateria.forEach( hora =>
            {
                let fila = buscarFilaPorHora( hora );
                if ( !fila )
                {
                    fila = crearFilaHorario( hora );
                }
                diasMateria.forEach( dia =>
                {
                    const colIndex = diasMapping[ dia ];
                    if ( colIndex !== undefined )
                    {
                        if ( fila.cells[ colIndex ].textContent.trim() !== "" )
                        {
                            fila.cells[ colIndex ].innerHTML += `<br><span class="mb-1 d-block">${ materiaNombre }</span>`; // Using innerHTML to render badge
                        } else
                        {
                            fila.cells[ colIndex ].innerHTML = `<span class="mb-1 d-block">${ materiaNombre }</span>`; // Using innerHTML to render badge
                        }
                    }
                } );
            } );
            select.remove( select.selectedIndex );
            select.selectedIndex = 0;
        }
    } );

    document.getElementById( 'guardarBtn' ).addEventListener( 'click', () =>
    {
        window.print(); // Replace with actual PDF generation logic
    } );
</script>

{% endif %}
{% endblock %}